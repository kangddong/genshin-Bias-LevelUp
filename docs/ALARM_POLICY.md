# Alarm Policy

## 1) 최초 알림 권한 요청
- 시점: 앱 시작 시
- 조건: 시스템 알림 권한 상태가 `notDetermined`일 때 즉시 `requestAuthorization` 호출
- 목적: 추적 시작 전에 권한 상태를 선반영해 UX 지연을 줄임

## 2) 거절(denied) 이후 재요청 정책
- iOS 정책상 동일 앱 내 시스템 권한 팝업 재노출은 불가
- 재요청 트리거: 사용자가 캐릭터/무기 추적을 시작(선택 ON)하려고 할 때
- 처리 방식: 앱 내 재요청 대신 시스템 설정 앱(`UIApplication.openSettingsURLString`)으로 라우팅

## 3) 알림 카테고리 정책
- `case1` (최애 알림):
  - 조건: 오늘 육성 가능한 대상에 사용자의 최애(캐릭터 또는 무기)가 포함될 때
  - 내용: 최애 이름 중심 `title` + 행동 유도 `body` + 최애 이미지
- `case2` (요일 알림):
  - 조건: `case1`, `case3` 미충족 시 기본 사용
  - 내용: 오늘/내일 오픈 수량 요약(캐릭터 n명, 무기 n개) + 대표 이미지(가능 시)
- `case3` (앱 활성유도 알림):
  - 조건: `case1` 미충족 + 마지막 앱 활성 이후 3일 이상 + 해당 날짜의 첫 슬롯
  - 내용: 복귀 유도 문구 + 오늘/내일 오픈 수량 요약 + 공통 이미지(`paimon`)
- 우선순위:
  - 동일 슬롯에서 `case1 > case3 > case2`
  - 세 케이스 모두 불충족이면 해당 슬롯은 생성하지 않음

## 4) 최애(Favorite) 정책
- 저장 단위: 캐릭터 1개 + 무기 1개
- 노출 위치:
  - 마이페이지 최상단에 현재 최애 상태 표시
  - 상세 페이지에서 최애 설정/해제 가능

## 5) 알림 시간 정책
- 알림 요일 설정: 제거
  - 앱 도메인이 요일 기반 오픈 정보이므로 사용자별 요일 토글은 중복 기능으로 간주
- 알림 시간:
  - 하루 최대 3회
  - 슬롯 간 최소 간격 4시간
- 스케줄 방식:
  - 서버 타임존(Asia/Shanghai) 기준
  - 롤링 14일 one-shot 로컬 알림을 재생성

## 6) 재스케줄 트리거
- 앱 시작/포그라운드 복귀
- 선택 대상 변경(캐릭터/무기)
- 최애 변경
- 알림 시간 슬롯 변경
- 권한 상태 변경
- 앱 시작/포그라운드 복귀 시 `lastAppOpenAt` 저장

## 7) 앱 활성 기준 데이터
- `lastAppOpenAt`를 `NotificationPreference`에 저장
- 미접속 일수 계산: `lastAppOpenAt`의 로컬 시작일 ~ 예약 발송일의 로컬 시작일 `day` 차이
- 음수 방지: 계산값은 최소 0으로 보정
